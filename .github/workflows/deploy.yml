name: Deploy VitePress to GitHub Pages

on:
  # 在推送到 main 或 develop 分支时触发
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'  # 当创建版本标签时触发
  # 允许手动触发
  workflow_dispatch:

# 设置 GITHUB_TOKEN 的权限,允许部署到 GitHub Pages
permissions:
  contents: write  # 改为 write 以允许提交文件
  pages: write
  id-token: write

# 只允许一个并发部署
concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取完整历史记录，用于生成文档
          ref: ${{ github.ref }} # 检出当前分支/标签
      
      - name: Fetch all branches and tags
        run: |
          git fetch --all --tags
          echo "已获取所有分支和标签"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Generate API documentation
        run: |
          cd api_struct/scripts
          python3 generate_whole_yaml.py
          python3 generate_json_from_yaml.py
          python3 generate_vitepress_docs.py

      - name: Sync versions from Git tags and branches
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          echo "当前分支/标签: $BRANCH_NAME"
          
          # 如果是标签推送，归档标签版本
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG_NAME="${{ github.ref_name }}"
            echo "✓ 检测到标签推送: $TAG_NAME"
            # 从标签对应的提交中提取文档（脚本会自动处理）
            VERSION_NAME=$(echo "$TAG_NAME" | sed 's/^v//')
            echo "将从标签 $TAG_NAME 提取文档到 docs/versions/$VERSION_NAME"
          # 如果是 develop 分支推送，创建 develop 版本
          elif [[ "${{ github.ref }}" == refs/heads/develop ]]; then
            echo "✓ 检测到 develop 分支推送"
            # 保存当前 develop 分支的 docs/src 到 versions/develop
            if [ -d "docs/src" ]; then
              echo "创建 develop 版本文档（从当前 develop 分支）"
              rm -rf "docs/versions/develop"
              mkdir -p "docs/versions/develop"
              cp -r docs/src/* "docs/versions/develop/"
              echo "✓ develop 版本已更新到 versions/develop/"
            fi
          # 如果是 main 分支推送，确保 main 版本是最新的
          elif [[ "${{ github.ref }}" == refs/heads/main ]]; then
            echo "✓ 检测到 main 分支推送"
            echo "main 版本使用 docs/src 目录（当前 main 分支）"
          fi
          
          # 强制同步所有标签版本（确保所有版本都被同步）
          echo "开始同步所有 Git 标签版本..."
          node docs/.vitepress/scripts/sync-versions-from-git.js --force || echo "版本同步完成（可能没有标签）"
          
          # 同步 develop 分支版本（如果 develop 分支存在）
          echo "检查并同步 develop 分支版本..."
          if git rev-parse --verify origin/develop >/dev/null 2>&1; then
            echo "✓ 找到 develop 分支，从 develop 分支提取文档"
            # 使用脚本从 develop 分支创建版本
            node docs/.vitepress/scripts/sync-versions-from-git.js --branch develop || echo "develop 版本同步完成"
          else
            echo "⚠ develop 分支不存在，跳过"
          fi
          
          # 验证版本目录
          echo "已同步的版本："
          ls -la docs/versions/ || echo "versions 目录为空"

      - name: Commit generated files
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          # 只提交生成的 API 文档，不提交 versions 目录（versions 目录仅用于构建，不需要提交到仓库）
          git add api_struct/generated/
          git diff --staged --quiet || git commit -m "chore: update generated API documentation [skip ci]"
          git push || echo "No changes to push"

      - name: Build VitePress
        run: npm run docs:build

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
